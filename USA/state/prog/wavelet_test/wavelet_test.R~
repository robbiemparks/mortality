rm(list=ls())

require(WaveletComp)

# load data and filter results
dat <- readRDS('USA_rate_pred_type1a_1982_2010')
dat <- subset(dat, fips==51 & sex==1 & age==85)

# prepare data frame for anaylsis
my.data <- data.frame(date=as.Date(as.character(dat$year),format='%Y'),log.rate=log(dat$rate.pred),log.deaths=log(dat$deaths))

# perform wavelet analysis
my.w <- analyze.wavelet(my.data, "log.deaths",
			lowerPeriod=4, upperPeriod=16,
			loess.span = 3/26,
			dt= 1, dj = 1/1000,
			make.pval= T, n.sim = 10)

# plot wavelet analysis
plot_1 <- wt.image(my.w, n.levels = 250,
	legend.params = list(lab = "wavelet power levels"),
	periodlab = "periods (months)", show.date = T,timelab = "",
	graphics.reset = F)
abline(h = log(12)/log(2))
mtext(text = "12", side = 2, at = log(12)/log(2), las = 1, line = 0.5)

wt.avg(my.w)

# reconstruct time series
reconstruct(my.w, plot.waves=F,lwd = c(1,2), legend.coords = "bottomleft")
